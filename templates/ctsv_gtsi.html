<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>手動測試說明 - GTS-I & CTS Verifier & MADA </title>
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
  >
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
  />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    /* 保留你原本樣式，必要的輕微調整（略過不影響功能的長 CSS） */
    * { box-sizing: border-box; font-family: "Segoe UI", "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    body { margin:0; padding:0; background:#f4f7fb; color:#111827; }
    header { background:#2563eb; color:#fff; padding:16px 32px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,.2); }
    header h1 { margin:0; font-size:20px; letter-spacing:.05em; } header .subtitle { font-size:13px; opacity:.9; }
    .nav-anchors a { color:#fff; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:14px; margin-left:10px; transition:background .2s; }
    .nav-anchors a:hover { background: rgba(255,255,255,.2); }
    main { max-width:1080px; margin:24px auto 32px; padding:0 16px; }
    .section-anchor { scroll-margin-top:80px; display:block; }
    .section-title { font-size:18px; margin:24px 0 12px; color:#1f2933; display:flex; align-items:center; gap:8px; }
    .section-title .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#dbeafe; color:#1d4ed8; }
    .android-subtitle { font-size:14px; margin:12px 0 8px; color:#4b5563; display:inline-flex; align-items:center; gap:6px; }
    .card-container { min-height:50px; }
    .card { background:#fff; border-radius:10px; padding:16px 18px; margin-bottom:12px; box-shadow:0 4px 10px rgba(15,23,42,0.07); border:1px solid #e5e7eb; position:relative; }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:5px; border-bottom:1px solid #eee; cursor:grab; }
    .card-title { font-size:15px; font-weight:600; color:#111827; margin:0; }
    .card small { font-size:11px; color:#6b7280; }
    .card ul li, .card ol li, .card p {font-size: 13px !important; line-height: 1.5; /* 確保行高正常，避免擠壓 */ }
    .card ul li code, .card ol li code, .card p code,
    .card ul li b, .card ol li b, .card p b {font-size: 13px !important; font-weight: 700;}
    /* 改為直排：figure 改成 block 並置中 */
    figure {
      margin:8px 0;
      padding:0;
      max-width:320px;
      width:100%;
      text-align:center;
      display:block; /* 由 inline-block 改為 block，改為每張一行 */
      margin-left: 0;
      margin-right: auto;
    }
    figure img { max-width:100%; border-radius:6px; border:1px solid #ddd; display:block; margin:0 auto; cursor:pointer; object-fit:contain; }
    figure figcaption { font-size:11px; color:#6b7280; margin-top:6px; word-break:break-all; text-align:center; }
    .note { margin-top:10px; font-size:12px; color:#374151; background:#eff6ff; border-radius:6px; padding:6px 8px; border-left:3px solid #2563eb; }
    .btn-action { padding:5px 10px; font-size:12px; border-radius:5px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; line-height:1; }
    .btn-edit { background-color:#3b82f6; color:white; border:1px solid #2563eb; }
    .btn-delete { background-color:#ef4444; color:white; border:1px solid #dc2626; }
    .image-thumb { width:80px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #ddd; margin-right:6px; }
    .modal-image-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .modal-image-item { display:inline-flex; flex-direction:column; align-items:center; gap:6px; }
    .remove-image-btn { font-size:11px; padding:3px 6px; border-radius:4px; background:#ef4444; color:#fff; border:none; cursor:pointer; }
    .small-muted { font-size:12px; color:#6b7280; }
    /* image preview modal tweaks */
    .modal-xl { max-width:1200px; }

    /* 卡片 attachments 改為垂直排列 */
    .card-attachments {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    /* 影片顯示跟圖片一致，佔整行 */
    .card-attachments .video-block {
      max-width: 300px;
      width: 100%;
      margin-left: 0;
      margin-right: auto;
      display: block;
    }
    .card-attachments .video-block video {
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #000;
      display: block;
    }

  </style>
</head>
<body>
<header>
  <div>
    <h1>手動測試說明</h1>
    <div class="subtitle">GTS-I / CTS Verifier / MADA Check List</div>
  </div>
  <div class="nav-anchors" id="header-nav">
       <button class="btn btn-sm btn-secondary" id="toggleDragBtn" onclick="toggleDragMode(event)" style="margin-left: 10px;">
          <i class="fas fa-hand-rock me-1"></i>
      </button>
  </div>
</header>

<main>
  <div id="content-container">
    <div class="text-center p-5" id="initial-loading">
        <p>正在載入數據，請稍候...</p>
    </div>
  </div>

  <div class="back-link">
    <a href="/">← 回到首頁</a>
  </div>
</main>

<!-- Modal (支援多圖上傳、編輯現有圖、刪除現有圖) -->
<div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cardModalLabel">新增/編輯測試卡片</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cardForm" enctype="multipart/form-data" novalidate>
                    <input type="hidden" id="card_id_pk" value="">

                    <div class="mb-3">
                        <label for="section_key" class="form-label">所屬區塊 (必填)</label>
                        <select class="form-select" id="section_key" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="card_title" class="form-label">卡片標題 (必填)</label>
                        <input type="text" class="form-control" id="card_title" required>
                        <small class="form-text text-muted">例如: Audio Loopback Latency Test</small>
                    </div>

                    <div class="mb-3">
                        <label for="card_subtitle" class="form-label">次要標題 / 備註</label>
                        <input type="text" class="form-control" id="card_subtitle">
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">內容 / SOP 步驟 (必填)</label>
                        <textarea class="form-control" id="content" rows="8" required></textarea>
                        <small class="form-text text-muted">每行一個步驟，若以 "Step" 或 "-" 開頭將自動格式化為列表。</small>
                    </div>

                    <div class="mb-3">
                        <label for="file_upload" class="form-label">從本機上傳圖片/附件（可多選）</label>
                        <input type="file" class="form-control" id="file_upload" name="file" multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.zip,.bmp,.webp,.mp4">
                        <small class="form-text small-muted">支援多選，上傳後會把檔案儲存到 static/uploads/，並自動加入圖片清單。</small>
                    </div>

                    <div>
                        <label class="form-label">現有圖片（可移除）</label>
                        <div class="modal-image-list" id="existingImages"></div>
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="note" class="form-label">Note Box 內容 (可選)</label>
                        <textarea class="form-control" id="note" rows="3"></textarea>
                        <small class="form-text text-muted">顯示在卡片底部的藍色 Note 區塊。</small>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveCardBtn">儲存</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal（點圖片放大） -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-2">
        <button type="button" class="btn-close float-end m-2" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="d-flex justify-content-center align-items-center" style="min-height:60vh;">
            <img id="imagePreviewImg" src="" alt="" style="max-width:100%; max-height:80vh; object-fit:contain; border-radius:6px; box-shadow:0 6px 20px rgba(0,0,0,0.2);">
        </div>
        <div class="p-2 text-center" id="imagePreviewCaption" style="font-size:13px; color:#6b7280;"></div>
      </div>
    </div>
  </div>
</div>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>

<script>
    // API 路徑
    const API_URL_CARDS = '/api/ctsv_gtsi/cards';
    const API_URL_SECTIONS = '/api/ctsv_gtsi/sections';
    const API_URL_UPLOAD = '/api/ctsv_gtsi/upload_file';

    // STATIC_BASE_URL 使用 Jinja 渲染（Flask 會把它替換成 /static/）
    const STATIC_BASE_URL = "{{ url_for('static', filename='') }}";

    const cardModalElement = document.getElementById('cardModal');
    const cardModal = new bootstrap.Modal(cardModalElement);
    const saveCardButton = document.getElementById('saveCardBtn');
    const toggleDragButton = document.getElementById('toggleDragBtn');

    let allSections = [];
    let allCards = [];

    // 表單欄位
    const formFields = {
        id: document.getElementById('card_id_pk'),
        section_key: document.getElementById('section_key'),
        card_title: document.getElementById('card_title'),
        card_subtitle: document.getElementById('card_subtitle'),
        content: document.getElementById('content'),
        note: document.getElementById('note'),
        file_upload: document.getElementById('file_upload'),
        existingImagesContainer: document.getElementById('existingImages')
    };

    // ==========================================================
    // 輔助：內容轉 HTML（支援 Step / - 轉換）
    // ==========================================================
    function renderContent(rawContent) {
        if (!rawContent) return '';
        const lines = rawContent.trim().split('\n');
        let html = '';
        let inList = false;
        let listType = null; // 'ol' or 'ul'
        lines.forEach(line => {
            const t = line.trim();
            if (!t) {
                if (inList) { html += `</${listType}>`; inList = false; listType = null; }
                return;
            }
            const isStep = /^Step\s+\d+\s*\./i.test(t);
            const isBullet = t.startsWith('-');
            if (isStep) {
                if (!inList || listType !== 'ol') { if (inList) html += `</${listType}>`; html += '<ol>'; inList = true; listType = 'ol'; }
                const txt = t.replace(/^Step\s+\d+\s*\.\s*/i, '');
                html += `<li>${txt.replace(/`([^`]+)`/g, '<code>$1</code>')}</li>`;
            } else if (isBullet) {
                if (!inList || listType !== 'ul') { if (inList) html += `</${listType}>`; html += '<ul>'; inList = true; listType = 'ul'; }
                const txt = t.replace(/^-+\s*/, '');
                html += `<li>${txt.replace(/`([^`]+)`/g, '<code>$1</code>')}</li>`;
            } else {
                if (inList) { html += `</${listType}>`; inList = false; listType = null; }
                html += `<p>${t.replace(/`([^`]+)`/g, '<code>$1</code>')}</p>`;
            }
        });
        if (inList) html += `</${listType}>`;
        return html;
    }

    // ==========================================================
    // 圖片渲染器（陣列或字串），含點擊放大
    // ==========================================================
    function renderImageOrLink(url) {
        if (!url) return '';
        url = String(url).trim();

        // 判斷是否為外部連結
        const isExternal = /^https?:\/\//i.test(url);
        const path = url.replace(/^static\//i, '');
        const href = isExternal ? url : (STATIC_BASE_URL + path);
        const lower = url.toLowerCase();

        const fileNameMatch = url.match(/[^/]+$/);
        const displayFileName = fileNameMatch ? fileNameMatch[0].replace(/^static\//i, '') : url;

        //  影片檔案
        if (/\.(mp4|webm|ogg)$/i.test(lower)) {
            // 使用 href（已包含 STATIC_BASE_URL 或外部連結）
            const safeHref = encodeURI(href);
            return `
                <div class="video-block">
                    <video controls>
                        <source src="${safeHref}">
                        您的瀏覽器不支援此影片標籤。
                    </video>
                    <div style="font-size:11px; color:#6b7280; margin-top:6px; word-break:break-all; text-align:center;">
                        ${escapeHtml(displayFileName)}
                    </div>
                </div>
            `;
        }

        // 圖片檔案
        if (/\.(jpe?g|png|gif|webp|bmp)$/i.test(lower)) {
            // 使用 encodeURI 防止特殊字元導致路徑錯誤
            const safeHref = encodeURI(href);
            return `
                <figure>
                    <a href="#" onclick="openImageModal('${safeHref}', '${escapeHtml(displayFileName)}'); return false;">
                        <img src="${safeHref}" loading="lazy" alt="${escapeHtml(displayFileName)}">
                    </a>
                    <figcaption>${escapeHtml(displayFileName)}</figcaption>
                </figure>
            `;
        }

        // PDF / zip 顯示為連結
        if (/\.(pdf|zip)$/i.test(lower)) {
            const linkText = lower.endsWith('.pdf') ? 'PDF 文件 (點擊開啟)' : '壓縮檔 (點擊下載)';
            const safeHref = encodeURI(href);
            return `<div class="note" style="border-left:3px solid #ff5757;">
                        <a href="${safeHref}" target="_blank" style="color:#ff5757;font-weight:600;">
                            <i class="fas fa-file-alt me-1"></i>${linkText}
                        </a>
                    </div>`;
        }

        // 其他外部連結
        if (isExternal) {
            const safeHref = encodeURI(href);
            return `<div class="note">
                        <a href="${safeHref}" target="_blank" style="color:#2563eb;font-weight:600;">
                            <i class="fas fa-external-link-alt me-1"></i> 外部參考連結
                        </a>
                    </div>`;
        }

        return '';
    }

    function renderImages(imageUrls) {
        if (!imageUrls) return '';
        if (!Array.isArray(imageUrls)) imageUrls = [imageUrls];

        let html = '';
        imageUrls.forEach(url => {
            if (!url) return;
            html += renderImageOrLink(url);
        });
        return html;
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // ==========================================================
    // 載入資料、渲染列表
    // ==========================================================
    async function loadAllData() {
        try {
            const sresp = await fetch(`${API_URL_SECTIONS}/list`);
            allSections = await sresp.json();

            const cresp = await fetch(`${API_URL_CARDS}/list`);
            // 後端回傳的每張 card 需包含 image_urls 欄位（陣列）
            allCards = await cresp.json();

            renderNavigation();
            renderContentLayout();
        } catch (e) {
            console.error("載入失敗:", e);
            document.getElementById('content-container').innerHTML = `<p class="text-center text-danger p-5">數據載入失敗，請檢查後端或網路。</p>`;
        }
    }

    function renderNavigation() {
        const navContainer = document.getElementById('header-nav');
        const selectContainer = document.getElementById('section_key');
        const toggleBtn = document.getElementById('toggleDragBtn');
        navContainer.innerHTML = '';
        if (toggleBtn) navContainer.appendChild(toggleBtn);
        selectContainer.innerHTML = '';

        allSections.forEach(section => {
            const key = section.section_key;
            navContainer.insertAdjacentHTML('afterbegin', `<a href="#${key.toLowerCase()}-anchor">${key}</a>`);
            selectContainer.insertAdjacentHTML('beforeend', `<option value="${key}">${section.title}</option>`);
        });
    }

    function renderContentLayout() {
        const container = document.getElementById('content-container');
        container.innerHTML = '';

        const cardsBySection = allCards.reduce((acc, card) => {
            const key = card.section_key.toUpperCase();
            acc[key] = acc[key] || [];
            acc[key].push(card);
            return acc;
        }, {});

        allSections.forEach(section => {
            const key = section.section_key;
            const cardData = cardsBySection[key] || [];

            let sectionHtml = `
                <div class="section-anchor" id="${key.toLowerCase()}-anchor"></div>
                <h2 class="section-title">
                    ${section.title}
                    <span class="tag">${section.tag}</span>

                        <button class="btn-action btn-edit ms-auto" onclick="openCardModal('${key}', null)">
                            <i class="fas fa-plus"></i> 新增筆記
                        </button>

                </h2>

                <div class="card-container" data-section-key="${key}" id="container-${key.toLowerCase()}">
                    ${cardData.map(card => renderCard(card)).join('')}
                    ${cardData.length === 0 ? `<p class="text-muted p-3 text-center">此區塊目前沒有測試卡片。</p>` : ''}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', sectionHtml);
        });

        allSections.forEach(section => initializeSorting(section.section_key));
    }

    function renderCard(card) {
        // card.image_urls 預期為陣列；若後端只存 image_url (字串)，請在後端回傳 image_urls: [image_url]
        const hasSubtitle = card.card_subtitle ? `<small>${card.card_subtitle}</small>` : '';
        const hasNote = card.note ? `<div class="note">${card.note}</div>` : '';
        const hasImages = (card.image_urls && card.image_urls.length) ? renderImages(card.image_urls) : '';
        return `
            <div class="card" data-card-id="${card.id}">
                <div class="card-header">
                    <h3 class="card-title">${card.card_title} ${hasSubtitle}</h3>
                    <div class="btn-group">
                         <button class="btn-action btn-edit" onclick="openCardModal('${card.section_key}', ${card.id})">
                             <i class="fas fa-pencil-alt"></i> 編輯
                         </button>
                         <button class="btn-action btn-delete" onclick="deleteCard(${card.id})">
                             <i class="fas fa-times"></i> 刪除
                         </button>
                    </div>
                </div>

                ${renderContent(card.content)}
                <div class="card-attachments">
                    ${hasImages}
                </div>
                ${hasNote}
            </div>
        `;
    }

    // ==========================================================
    // Sortable drag (same as before)
    // ==========================================================
    function initializeSorting(sectionKey) {
        const container = document.getElementById(`container-${sectionKey.toLowerCase()}`);
        if (!container || typeof Sortable === 'undefined') return;

        Sortable.create(container, {
            group: 'ctsv-cards',
            animation: 150,
            handle: '.card-header', // 改成 header 為 handle（比較直覺）
            ghostClass: 'sortable-ghost',
            disabled: true,
            onEnd: async function (evt) {
                const isMoved = evt.from !== evt.to;
                const oldSectionKey = evt.from.getAttribute('data-section-key');
                const newSectionKey = evt.to.getAttribute('data-section-key');
                const movedCardId = evt.item.getAttribute('data-card-id');

                if (isMoved && movedCardId && oldSectionKey !== newSectionKey) {
                    await updateCardSectionKey(movedCardId, newSectionKey);
                }

                await saveNewOrder(newSectionKey);

                if (isMoved && oldSectionKey !== newSectionKey) {
                    await saveNewOrder(oldSectionKey);
                }

                loadAllData();
            }
        });
    }

    async function updateCardSectionKey(cardId, newSectionKey) {
        const card = allCards.find(c => c.id == cardId);
        if (!card) return;
        try {
            const response = await fetch(`${API_URL_CARDS}/update/${cardId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    section_key: newSectionKey,
                    card_title: card.card_title,
                    content: card.content,
                    card_subtitle: card.card_subtitle,
                    note: card.note,
                    image_urls: card.image_urls || []
                })
            });
            if (!response.ok) throw new Error("更新 section key 失敗");
        } catch (e) {
            console.error(e);
            alert("警告: 卡片移動/更新失敗");
        }
    }

    async function saveNewOrder(sectionKey) {
         const container = document.getElementById(`container-${sectionKey.toLowerCase()}`);
         if (!container) return;
         const newOrderIds = Array.from(container.children).map(item => item.getAttribute('data-card-id')).filter(Boolean).map(x => parseInt(x));
         if (newOrderIds.length === 0) return;
         try {
             const response = await fetch(`${API_URL_CARDS}/reorder/${sectionKey}`, {
                 method: 'PUT',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify(newOrderIds)
             });
             if (!response.ok) throw new Error("儲存排序失敗");
         } catch (e) { console.error("saveNewOrder error:", e); }
    }

    // ==========================================================
    // Modal control: open (新增/編輯)
    // ==========================================================
    function openCardModal(sectionKey, cardId) {
        // reset
        formFields.id.value = '';
        formFields.section_key.value = sectionKey || (allSections[0] && allSections[0].section_key) || '';
        formFields.card_title.value = '';
        formFields.card_subtitle.value = '';
        formFields.content.value = '';
        formFields.note.value = '';
        formFields.file_upload.value = '';
        formFields.existingImagesContainer.innerHTML = '';

        if (cardId) {
            const card = allCards.find(c => c.id == cardId);
            if (!card) {
                alert("找不到該卡片資料（可能已被刪除）");
                return;
            }
            formFields.id.value = card.id;
            formFields.section_key.value = card.section_key;
            formFields.card_title.value = card.card_title;
            formFields.card_subtitle.value = card.card_subtitle || '';
            formFields.content.value = card.content || '';
            formFields.note.value = card.note || '';
            // show existing images
            const imgs = card.image_urls || [];
            imgs.forEach((p, idx) => {
                appendExistingImage(p);
            });
        } else {
            // 新增：一開始空的 existingImages
        }

        cardModal.show();
    }

    // append existing image DOM (可刪除)
    function appendExistingImage(path) {
        const container = formFields.existingImagesContainer;
        const item = document.createElement('div');
        item.className = 'modal-image-item';
        const isExternal = /^https?:\/\//i.test(path);
        const relPath = path.replace(/^static\//i, '');
        const src = isExternal ? path : (STATIC_BASE_URL + relPath);

        let mediaEl;
          if (/\.(mp4|webm|ogg)$/i.test(path)) {
                // 影片用 icon 代替預覽
                mediaEl = document.createElement('div');
                mediaEl.innerHTML = '<i class="fas fa-video fa-2x text-muted"></i>';
                mediaEl.style.width = '80px';
                mediaEl.style.height = '60px';
                mediaEl.style.display = 'flex';
                mediaEl.style.alignItems = 'center';
                mediaEl.style.justifyContent = 'center';
                mediaEl.style.border = '1px solid #ddd';
                mediaEl.style.borderRadius = '6px';
          } else {
                mediaEl = document.createElement('img');
                // encodeURI 避免特殊字元造成問題
                try { mediaEl.src = encodeURI(src); } catch(e){ mediaEl.src = src; }
                mediaEl.className = 'image-thumb';
          }

        const cap = document.createElement('div');
        cap.style.fontSize = '11px';
        cap.style.maxWidth = '90px';
        cap.style.wordBreak = 'break-all';
        cap.textContent = path;
        const btn = document.createElement('button');
        btn.className = 'remove-image-btn';
        btn.type = 'button';
        btn.textContent = '移除';
        btn.onclick = () => { container.removeChild(item); };
        item.appendChild(mediaEl);
        item.appendChild(cap);
        item.appendChild(btn);
        // store the path in dataset so we can collect later
        item.dataset.path = path;
        container.appendChild(item);
    }

    // ==========================================================
    // 儲存卡片（新增/更新） — 支援多檔上傳與 existing images
    // ==========================================================
    saveCardButton.addEventListener('click', async () => {
        // form 驗證
        if (!document.getElementById('cardForm').checkValidity()) {
            document.getElementById('cardForm').reportValidity();
            return;
        }

        const id = formFields.id.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL_CARDS}/update/${id}` : `${API_URL_CARDS}/add`;

        // 1) 先把 modal 中剩下的 existing images 收集起來
        const existingImgs = Array.from(formFields.existingImagesContainer.children).map(el => el.dataset.path).filter(Boolean);

        // 2) 上傳用戶剛選擇的新檔案（若有）
        const uploadedPaths = [];
        const files = Array.from(formFields.file_upload.files || []);
        for (const f of files) {
            const fd = new FormData();
            fd.append('file', f);
            try {
                const upl = await fetch(API_URL_UPLOAD, { method: 'POST', body: fd });
                const res = await upl.json();
                if (upl.ok && res.status === 'ok') {
                    // res.file_path 例如: xxx.jpg
                    uploadedPaths.push(res.file_path);
                } else {
                    alert('檔案上傳失敗: ' + (res.message || '伺服器錯誤'));
                    return;
                }
            } catch (e) {
                console.error('upload error', e);
                alert('檔案上傳失敗，請檢查後端服務');
                return;
            }
        }

        // 3) 最終 image_urls = existingImgs + uploadedPaths
        const finalImageUrls = existingImgs.concat(uploadedPaths);

        // 4) 準備 payload
        const payload = {
            section_key: formFields.section_key.value,
            card_title: formFields.card_title.value,
            card_subtitle: formFields.card_subtitle.value,
            content: formFields.content.value,
            note: formFields.note.value,
            image_urls: finalImageUrls
        };

        try {
            const resp = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (resp.ok) {
                alert(`卡片已${id ? '更新' : '新增'}成功！`);
                cardModal.hide();
                loadAllData();
            } else {
                const err = await resp.json();
                alert('操作失敗: ' + (err.message || '伺服器錯誤'));
            }
        } catch (e) {
            console.error('save error', e);
            alert('連線失敗，請檢查後端');
        }
    });

    // ==========================================================
    // 刪除卡片 / 區塊
    // ==========================================================
    async function deleteCard(cardId) {
        if (!confirm(`確定要刪除這張卡片 ID: ${cardId} 嗎？`)) return;
        try {
            const resp = await fetch(`${API_URL_CARDS}/delete/${cardId}`, { method: 'DELETE' });
            if (resp.ok) {
                alert('刪除成功');
                loadAllData();
            } else {
                const e = await resp.json();
                alert('刪除失敗: ' + (e.message || '伺服器錯誤'));
            }
        } catch (e) {
            alert('連線失敗');
        }
    }

    async function deleteSection(sectionKey, event) {
        event.preventDefault();
        const cardsCount = allCards.filter(c => c.section_key === sectionKey).length;
        const confirmMsg = cardsCount > 0 ? `警告: 區塊 "${sectionKey}" 下還有 ${cardsCount} 張卡片。確定要刪除整個區塊及其所有卡片嗎？` : `確定要刪除區塊 "${sectionKey}" 嗎？`;
        if (!confirm(confirmMsg)) return;
        try {
            const resp = await fetch(`${API_URL_SECTIONS}/delete/${sectionKey}`, { method: 'DELETE' });
            if (resp.ok) {
                alert('區塊刪除成功');
                loadAllData();
            } else {
                const e = await resp.json();
                alert('刪除失敗: ' + (e.message || '伺服器錯誤'));
            }
        } catch (e) {
            alert('連線失敗');
        }
    }

    // ==========================================================
    // Drag toggle
    // ==========================================================
    function toggleDragMode(event) {
        event.preventDefault();
        const cardContainers = document.querySelectorAll('.card-container');
        if (!cardContainers.length) return;
        let isDraggingEnabled = !cardContainers[0].classList.contains('drag-mode');
        cardContainers.forEach(cont => {
            const instance = Sortable.get(cont);
            if (instance) instance.option("disabled", !isDraggingEnabled);
            cont.classList.toggle('drag-mode', isDraggingEnabled);
        });
        if (isDraggingEnabled) {
            toggleDragButton.innerHTML = '<i class="fas fa-mouse-pointer me-1"></i>';
            toggleDragButton.classList.remove('btn-secondary'); toggleDragButton.classList.add('btn-warning');
        } else {
            toggleDragButton.innerHTML = '<i class="fas fa-hand-rock me-1"></i>';
            toggleDragButton.classList.remove('btn-warning'); toggleDragButton.classList.add('btn-secondary');
        }
    }

    // ==========================================================
    // Image preview modal 控制
    // ==========================================================
    function openImageModal(src, caption) {
        try { src = decodeURI(src); } catch (e) {}
        const img = document.getElementById('imagePreviewImg');
        const cap = document.getElementById('imagePreviewCaption');
        img.src = src;
        img.alt = caption || '';
        cap.textContent = caption || '';

        const modalEl = document.getElementById('imagePreviewModal');
        const bsModal = new bootstrap.Modal(modalEl, { keyboard: true });
        bsModal.show();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('imagePreviewModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function () {
                const img = document.getElementById('imagePreviewImg');
                if (img) img.src = '';
                const cap = document.getElementById('imagePreviewCaption');
                if (cap) cap.textContent = '';
            });
        }
    });

    // 暴露全域（供 html inline onclick 使用）
    window.openCardModal = openCardModal;
    window.deleteCard = deleteCard;
    window.deleteSection = deleteSection;
    window.toggleDragMode = toggleDragMode;

    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
</body>
</html>
