<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>手動測試說明 - GTS-I & CTS Verifier & MADA</title>
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
  >
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
  />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    /* ================= 基礎樣式 ================= */
    * { box-sizing: border-box; font-family: "Segoe UI", "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }
    body { margin:0; padding:0; background:#f4f7fb; color:#111827; }
    
    /* Header (固定置頂) */
    header { background:#2563eb; color:#fff; padding:16px 32px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:1000; box-shadow:0 2px 5px rgba(0,0,0,.2); }
    header h1 { margin:0; font-size:20px; letter-spacing:.05em; } 
    header .subtitle { font-size:13px; opacity:.9; }
    
    .nav-anchors { display: flex; align-items: center; }
    .nav-anchors a { color:#fff; text-decoration:none; padding:6px 10px; border-radius:4px; font-size:14px; margin-left:10px; transition:background .2s; cursor: pointer; }
    .nav-anchors a:hover { background: rgba(255,255,255,.2); }
    
    main { max-width:1080px; margin:24px auto 32px; padding:0 16px; }
    
    /* ================= 關鍵修正: 錨點定位 ================= */
    /* 配合你的程式碼，section-anchor 會被插入在標題上方 */
    /* scroll-margin-top 確保跳轉後，瀏覽器預留 Header 的高度 */
    .section-anchor {
        scroll-margin-top: 100px; 
        display: block;
        height: 0;
        visibility: hidden;
    }
    
    .section-title { font-size:18px; margin:24px 0 12px; color:#1f2933; display:flex; align-items:center; gap:8px; }
    .section-title .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#dbeafe; color:#1d4ed8; }
    
    /* Card Styles */
    .card-container { min-height:50px; }
    .card { background:#fff; border-radius:10px; padding:16px 18px; margin-bottom:12px; box-shadow:0 4px 10px rgba(15,23,42,0.07); border:1px solid #e5e7eb; position:relative; }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:5px; border-bottom:1px solid #eee; }
    .card-container.drag-mode .card-header {cursor: grab;}
    .card-title { font-size:15px; font-weight:600; color:#111827; margin:0; }
    .card small { font-size:11px; color:#6b7280; }
    
    /* 內容排版 */
    .card ul li, .card ol li, .card p {font-size: 13px !important; line-height: 1.5; }
    .card ul li code, .card ol li code, .card p code, .card ul li b, .card ol li b, .card p b {font-size: 13px !important; font-weight: 700;}
    
    /* 圖片樣式 */
    figure { margin:8px 0; padding:0; max-width:320px; width:100%; text-align:center; display:block; margin-right: auto; }
    figure img { max-width:100%; border-radius:6px; border:1px solid #ddd; display:block; margin:0 auto; cursor:pointer; object-fit:contain; }
    figure figcaption { font-size:11px; color:#6b7280; margin-top:6px; word-break:break-all; text-align:center; }
    
    .note { margin-top:10px; font-size:12px; color:#374151; background:#eff6ff; border-radius:6px; padding:6px 8px; border-left:3px solid #2563eb; }
    
    /* 按鈕樣式 */
    .btn-action { padding:5px 10px; font-size:12px; border-radius:5px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; line-height:1; }
    .btn-edit { background-color:#3b82f6; color:white; border:1px solid #2563eb; }
    .btn-delete { background-color:#ef4444; color:white; border:1px solid #dc2626; }
    
    /* Modal Image Styles */
    .image-thumb { width:80px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #ddd; margin-right:6px; }
    .modal-image-list { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .modal-image-item { display:inline-flex; flex-direction:column; align-items:center; gap:6px; }
    .remove-image-btn { font-size:11px; padding:3px 6px; border-radius:4px; background:#ef4444; color:#fff; border:none; cursor:pointer; }
    .small-muted { font-size:12px; color:#6b7280; }
    .modal-xl { max-width:1200px; }

    /* Attachments Layout */
    .card-attachments { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    
    /* Video Styles */
    .card-attachments .video-block { max-width: 300px; width: 100%; margin-right: auto; display: block; }
    .card-attachments .video-block video { width: 100%; border-radius: 6px; border: 1px solid #ddd; background: #000; display: block; }
  </style>
</head>
<body>
<header>
  <div>
    <h1>手動測試說明</h1>
    <div class="subtitle">GTS-I / CTS Verifier / MADA Check List</div>
  </div>
  <div class="nav-anchors" id="header-nav">
      <button class="btn btn-sm btn-secondary" id="toggleDragBtn" onclick="toggleDragMode(event)" style="margin-left: 10px;">
          <i class="fas fa-hand-rock me-1"></i>
      </button>
  </div>
</header>

<main>
  <div id="content-container">
    <div class="text-center p-5" id="initial-loading">
        <p>正在載入數據，請稍候...</p>
    </div>
  </div>

  <div class="back-link">
    <a href="/">← 回到首頁</a>
  </div>
</main>

<div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增/編輯測試卡片</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cardForm" enctype="multipart/form-data" novalidate>
                    <input type="hidden" id="card_id_pk" value="">

                    <div class="mb-3">
                        <label for="section_key" class="form-label">所屬區塊 (必填)</label>
                        <select class="form-select" id="section_key" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="card_title" class="form-label">卡片標題 (必填)</label>
                        <input type="text" class="form-control" id="card_title" required>
                    </div>

                    <div class="mb-3">
                        <label for="card_subtitle" class="form-label">次要標題 / 備註</label>
                        <input type="text" class="form-control" id="card_subtitle">
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">內容 / SOP 步驟 (必填)</label>
                        <textarea class="form-control" id="content" rows="8" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="file_upload" class="form-label">從本機上傳圖片/附件</label>
                        <input type="file" class="form-control" id="file_upload" name="file" multiple accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.zip,.mp4,.mov,.webm">
                        <small class="text-muted">支援圖片、影片 (MP4/MOV)、PDF、Zip</small>
                    </div>

                    <div>
                        <label class="form-label">現有圖片</label>
                        <div class="modal-image-list" id="existingImages"></div>
                    </div>

                    <div class="mb-3 mt-3">
                        <label for="note" class="form-label">Note Box</label>
                        <textarea class="form-control" id="note" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveCardBtn">儲存</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body p-2">
        <button type="button" class="btn-close float-end m-2" data-bs-dismiss="modal" aria-label="Close"></button>
        <div class="d-flex justify-content-center align-items-center" style="min-height:60vh;">
            <img id="imagePreviewImg" src="" style="max-width:100%; max-height:80vh; object-fit:contain;">
        </div>
        <div class="p-2 text-center" id="imagePreviewCaption" style="font-size:13px; color:#6b7280;"></div>
      </div>
    </div>
  </div>
</div>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>

<script>
    // Config
    const API_URL_CARDS = '/api/ctsv_gtsi/cards';
    const API_URL_SECTIONS = '/api/ctsv_gtsi/sections';
    const API_URL_UPLOAD = '/api/ctsv_gtsi/upload_file';
    const STATIC_BASE_URL = "{{ url_for('static', filename='') }}";

    const cardModalElement = document.getElementById('cardModal');
    const cardModal = new bootstrap.Modal(cardModalElement);
    const saveCardButton = document.getElementById('saveCardBtn');
    const toggleDragButton = document.getElementById('toggleDragBtn');

    let allSections = [];
    let allCards = [];

    const formFields = {
        id: document.getElementById('card_id_pk'),
        section_key: document.getElementById('section_key'),
        card_title: document.getElementById('card_title'),
        card_subtitle: document.getElementById('card_subtitle'),
        content: document.getElementById('content'),
        note: document.getElementById('note'),
        file_upload: document.getElementById('file_upload'),
        existingImagesContainer: document.getElementById('existingImages')
    };

    // ==========================================================
    // 1. helper: 產生 URL 安全且唯一的 slug（保證不衝突）
    // ==========================================================
    function makeSlug(key, index) {
        // 把空白/特殊字元轉成 dash，並帶上 index 確保唯一
        return (String(key || '').toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^\w\-]/g, '')
            .replace(/\-+/g, '-')
            || 'section') + '-' + index;
    }

    // ==========================================================
    // 2. 更新 renderNavigation，改成使用 safe slug 並攔截點擊事件
    // ==========================================================
    function renderNavigation() {
        const navContainer = document.getElementById('header-nav');
        const selectContainer = document.getElementById('section_key');
        const toggleBtn = document.getElementById('toggleDragBtn');
        navContainer.innerHTML = '';
        if (toggleBtn) navContainer.appendChild(toggleBtn);
        selectContainer.innerHTML = '';

        allSections.forEach((section, idx) => {
            const key = section.section_key;
            const slug = makeSlug(key, idx); // 唯一 slug
            // 把 slug 存回 section 物件，供 renderContentLayout 使用
            section._slug = slug;

            // 建一個 a 元素並攔截點擊以用 scrollIntoView（避免原生 anchor 在動態載入時跳錯）
            const a = document.createElement('a');
            a.href = `#${slug}`;
            a.textContent = key;
            a.dataset.target = slug;
            a.addEventListener('click', function (ev) {
                ev.preventDefault();
                const target = document.getElementById(slug);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // 更新 hash（不會觸發預設跳動）
                    history.replaceState(null, '', `#${slug}`);
                }
            });
            // 插到 nav（保留原本順序）
            navContainer.appendChild(a);

            selectContainer.insertAdjacentHTML('beforeend', `<option value="${section.section_key}">${escapeHtml(section.title)}</option>`);
        });
    }

    // ==========================================================
    // 3. renderContentLayout: 每個 section 使用 section._slug 當 id
    // ==========================================================
    function renderContentLayout() {
        const container = document.getElementById('content-container');
        container.innerHTML = '';

        const cardsBySection = allCards.reduce((acc, card) => {
            const key = (card.section_key || '').toUpperCase();
            acc[key] = acc[key] || [];
            acc[key].push(card);
            return acc;
        }, {});

        allSections.forEach((section) => {
            const key = section.section_key;
            const slug = section._slug || makeSlug(key, 0);
            const cardData = cardsBySection[key] || [];

            let sectionHtml = `
                <div class="section-anchor" id="${slug}"></div>
                <h2 class="section-title">
                    ${escapeHtml(section.title)}
                    <span class="tag">${escapeHtml(section.tag || '')}</span>
                    <button class="btn-action btn-edit ms-auto" onclick="openCardModal('${key}', null)">
                        <i class="fas fa-plus"></i> 新增筆記
                    </button>
                </h2>

                <div class="card-container" data-section-key="${key}" id="container-${slug}">
                    ${cardData.map(card => renderCard(card)).join('')}
                    ${cardData.length === 0 ? `<p class="text-muted p-3 text-center">此區塊目前沒有測試卡片。</p>` : ''}
                </div>
            `;
            container.insertAdjacentHTML('beforeend', sectionHtml);
        });

        // 初始化 sortable（注意：container id 改為 container-${slug}）
        allSections.forEach(section => {
            const slug = section._slug;
            if (slug) initializeSortingBySlug(slug, section.section_key);
        });

        // 若 URL 有 hash（或使用者點了上方 nav），確保滾動到對應位置
        handleHashScroll();
    }

    // 因為 container id 改為 container-${slug}，create sorting 用這個 helper
    function initializeSortingBySlug(slug, sectionKey) {
        const container = document.getElementById(`container-${slug}`);
        if (!container || typeof Sortable === 'undefined') return;

        Sortable.create(container, {
            group: 'ctsv-cards',
            animation: 150,
            handle: '.card-header',
            ghostClass: 'sortable-ghost',
            disabled: true,
            onEnd: async function (evt) {
                const isMoved = evt.from !== evt.to;
                const oldSectionKey = evt.from.getAttribute('data-section-key');
                const newSectionKey = evt.to.getAttribute('data-section-key');
                const movedCardId = evt.item.getAttribute('data-card-id');

                if (isMoved && movedCardId && oldSectionKey !== newSectionKey) {
                    await updateCardSectionKey(movedCardId, newSectionKey);
                }

                await saveNewOrder(newSectionKey);

                if (isMoved && oldSectionKey !== newSectionKey) {
                    await saveNewOrder(oldSectionKey);
                }

                loadAllData();
            }
        });
    }

    // 若網址有 hash，嘗試滾動到對應的 slug（等 DOM 建好後再做）
    function handleHashScroll() {
        const h = location.hash;
        if (!h) return;
        try {
            const id = h.replace('#', '');
            const el = document.getElementById(id);
            if (el) {
                // 延遲微小時間，確保 DOM 風格已經渲染（必要時可調整）
                setTimeout(() => {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 80);
            }
        } catch (e) { /* ignore */ }
    }

    // ==========================================================
    // 4. 更新 renderImageOrLink：video 加上 type 並使用 safer src
    // ==========================================================
    function renderImageOrLink(url) {
        if (!url) return '';
        url = String(url).trim();

        const isExternal = /^https?:\/\//i.test(url);
        const path = url.replace(/^static\//i, '');
        const href = isExternal ? url : (STATIC_BASE_URL + path);
        const lower = url.toLowerCase();
        const fileNameMatch = url.match(/[^/]+$/);
        const displayFileName = fileNameMatch ? fileNameMatch[0].replace(/^static\//i, '') : url;

        // 判別 mime type
        let mimeType = '';
        if (/\.(mp4)$/i.test(lower)) mimeType = 'video/mp4';
        else if (/\.(mov)$/i.test(lower)) mimeType = 'video/quicktime';
        else if (/\.(webm)$/i.test(lower)) mimeType = 'video/webm';
        else if (/\.(ogg)$/i.test(lower)) mimeType = 'video/ogg';

        if (mimeType) {
            const safeHref = encodeURI(href);
            return `
                <div class="video-block">
                    <video controls playsinline preload="metadata">
                        <source src="${safeHref}" type="${mimeType}">
                        您的瀏覽器不支援此影片標籤。
                    </video>
                    <div style="font-size:11px; color:#6b7280; margin-top:6px; word-break:break-all; text-align:center;">
                        ${escapeHtml(displayFileName)}
                    </div>
                </div>
            `;
        }

        // 圖片...
        if (/\.(jpe?g|png|gif|webp|bmp)$/i.test(lower)) {
            const safeHref = encodeURI(href);
            return `
                <figure>
                    <a href="#" onclick="openImageModal('${safeHref}', '${escapeHtml(displayFileName)}'); return false;">
                        <img src="${safeHref}" loading="lazy" alt="${escapeHtml(displayFileName)}">
                    </a>
                    <figcaption>${escapeHtml(displayFileName)}</figcaption>
                </figure>
            `;
        }

        // PDF / zip
        if (/\.(pdf|zip)$/i.test(lower)) {
            const linkText = lower.endsWith('.pdf') ? 'PDF 文件 (點擊開啟)' : '壓縮檔 (點擊下載)';
            const safeHref = encodeURI(href);
            return `<div class="note" style="border-left:3px solid #ff5757;">
                        <a href="${safeHref}" target="_blank" style="color:#ff5757;font-weight:600;">
                            <i class="fas fa-file-alt me-1"></i>${linkText}
                        </a>
                    </div>`;
        }

        // 外部連結 fallback
        if (isExternal) {
            const safeHref = encodeURI(href);
            return `<div class="note">
                        <a href="${safeHref}" target="_blank" style="color:#2563eb;font-weight:600;">
                            <i class="fas fa-external-link-alt me-1"></i> 外部參考連結
                        </a>
                    </div>`;
        }

        return '';
    }

    // ==========================================================
    // 5. appendExistingImage：若是影片則顯示可播放的縮圖（小影片）而不是單純 icon
    // ==========================================================
    function appendExistingImage(path) {
        const container = formFields.existingImagesContainer;
        const item = document.createElement('div');
        item.className = 'modal-image-item';
        const isExternal = /^https?:\/\//i.test(path);
        const relPath = path.replace(/^static\//i, '');
        const src = isExternal ? path : (STATIC_BASE_URL + relPath);

        let mediaEl;
        if (/\.(mp4|mov|webm|ogg)$/i.test(path)) {
            // 建一個小型 video element（可播放）
            mediaEl = document.createElement('video');
            mediaEl.width = 160;
            mediaEl.height = 90;
            mediaEl.controls = true;
            mediaEl.preload = 'metadata';
            mediaEl.playsInline = true;
            try { mediaEl.src = encodeURI(src); } catch (e) { mediaEl.src = src; }
            mediaEl.style.border = '1px solid #ddd';
            mediaEl.style.borderRadius = '6px';
            mediaEl.style.objectFit = 'cover';
        } else {
            mediaEl = document.createElement('img');
            try { mediaEl.src = encodeURI(src); } catch(e){ mediaEl.src = src; }
            mediaEl.className = 'image-thumb';
        }

        const cap = document.createElement('div');
        cap.style.fontSize = '11px';
        cap.style.maxWidth = '140px';
        cap.style.wordBreak = 'break-all';
        cap.textContent = path;
        const btn = document.createElement('button');
        btn.className = 'remove-image-btn';
        btn.type = 'button';
        btn.textContent = '移除';
        btn.onclick = () => { container.removeChild(item); };
        item.appendChild(mediaEl);
        item.appendChild(cap);
        item.appendChild(btn);
        item.dataset.path = path;
        container.appendChild(item);
    }
    
    // ==========================================================
    // 6. 基礎功能 (載入、渲染卡片內容、Modal 操作、上傳)
    // ==========================================================
    async function loadAllData() {
        try {
            const sresp = await fetch(`${API_URL_SECTIONS}/list`);
            allSections = await sresp.json();
            const cresp = await fetch(`${API_URL_CARDS}/list`);
            allCards = await cresp.json();
            
            // 載入順序：先算好 slug 導覽列，再渲染內容
            renderNavigation();
            renderContentLayout();
        } catch (e) {
            console.error("載入失敗:", e);
            document.getElementById('content-container').innerHTML = `<p class="text-center text-danger p-5">數據載入失敗，請檢查後端或網路。</p>`;
        }
    }

    function renderContent(rawContent) {
        if (!rawContent) return '';
        const lines = rawContent.trim().split('\n');
        let html = '';
        let inList = false;
        let listType = null;
        lines.forEach(line => {
            const t = line.trim();
            if (!t) {
                if (inList) { html += `</${listType}>`; inList = false; }
                return;
            }
            if (/^Step\s+\d+\s*\./i.test(t)) {
                if (!inList || listType !== 'ol') { if (inList) html += `</${listType}>`; html += '<ol>'; inList = true; listType = 'ol'; }
                html += `<li>${t.replace(/^Step\s+\d+\s*\.\s*/i, '').replace(/`([^`]+)`/g, '<code>$1</code>')}</li>`;
            } else if (t.startsWith('-')) {
                if (!inList || listType !== 'ul') { if (inList) html += `</${listType}>`; html += '<ul>'; inList = true; listType = 'ul'; }
                html += `<li>${t.replace(/^-+\s*/, '').replace(/`([^`]+)`/g, '<code>$1</code>')}</li>`;
            } else {
                if (inList) { html += `</${listType}>`; inList = false; }
                html += `<p>${t.replace(/`([^`]+)`/g, '<code>$1</code>')}</p>`;
            }
        });
        if (inList) html += `</${listType}>`;
        return html;
    }

    function renderImages(imageUrls) {
        if (!imageUrls) return '';
        if (!Array.isArray(imageUrls)) imageUrls = [imageUrls];
        return imageUrls.map(renderImageOrLink).join('');
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderCard(card) {
        const hasSubtitle = card.card_subtitle ? `<small>${card.card_subtitle}</small>` : '';
        const hasNote = card.note ? `<div class="note">${card.note}</div>` : '';
        const hasImages = (card.image_urls && card.image_urls.length) ? renderImages(card.image_urls) : '';
        return `
            <div class="card" data-card-id="${card.id}">
                <div class="card-header">
                    <h3 class="card-title">${card.card_title} ${hasSubtitle}</h3>
                    <div class="btn-group">
                          <button class="btn-action btn-edit" onclick="openCardModal('${card.section_key}', ${card.id})">
                             <i class="fas fa-pencil-alt"></i> 編輯
                          </button>
                          <button class="btn-action btn-delete" onclick="deleteCard(${card.id})">
                             <i class="fas fa-times"></i> 刪除
                          </button>
                    </div>
                </div>
                ${renderContent(card.content)}
                <div class="card-attachments">${hasImages}</div>
                ${hasNote}
            </div>
        `;
    }

    async function updateCardSectionKey(cardId, newSectionKey) {
        const card = allCards.find(c => c.id == cardId);
        if (!card) return;
        await fetch(`${API_URL_CARDS}/update/${cardId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ ...card, section_key: newSectionKey })
        });
    }

    async function saveNewOrder(sectionKey) {
         // 注意：這裡要透過 makeSlug 找回正確的 container ID，但因為我們只有 sectionKey，
         // 比較保險的做法是重新遍歷或簡單使用 safe ID 邏輯。
         // 這裡為簡化，假設 sectionKey 對應的 slug 規則一致 (index 0)
         const slug = makeSlug(sectionKey, 0); 
         const container = document.getElementById(`container-${slug}`);
         
         if (!container) return;
         const newOrderIds = Array.from(container.children).map(i => i.getAttribute('data-card-id')).filter(Boolean).map(x => parseInt(x));
         if (newOrderIds.length === 0) return;
         await fetch(`${API_URL_CARDS}/reorder/${sectionKey}`, {
             method: 'PUT',
             headers: {'Content-Type': 'application/json'},
             body: JSON.stringify(newOrderIds)
         });
    }

    // Modal 與儲存邏輯
    saveCardButton.addEventListener('click', async () => {
        if (!document.getElementById('cardForm').checkValidity()) {
            document.getElementById('cardForm').reportValidity();
            return;
        }

        const id = formFields.id.value;
        const existingImgs = Array.from(formFields.existingImagesContainer.children).map(el => el.dataset.path);
        const uploadedPaths = [];
        const files = Array.from(formFields.file_upload.files || []);

        for (const f of files) {
            const fd = new FormData();
            fd.append('file', f);
            try {
                const resp = await fetch(API_URL_UPLOAD, { method: 'POST', body: fd });
                if (!resp.ok) {
                    alert(`上傳失敗: ${f.name} (Code: ${resp.status})`);
                    continue; 
                }
                const res = await resp.json();
                if (res.status === 'ok') uploadedPaths.push(res.file_path);
            } catch (e) { alert('上傳錯誤'); return; }
        }

        const payload = {
            section_key: formFields.section_key.value,
            card_title: formFields.card_title.value,
            card_subtitle: formFields.card_subtitle.value,
            content: formFields.content.value,
            note: formFields.note.value,
            image_urls: existingImgs.concat(uploadedPaths)
        };

        const url = id ? `${API_URL_CARDS}/update/${id}` : `${API_URL_CARDS}/add`;
        const method = id ? 'PUT' : 'POST';

        try {
            const resp = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            if (resp.ok) {
                cardModal.hide();
                loadAllData();
            } else {
                alert('儲存失敗');
            }
        } catch (e) { alert('連線錯誤'); }
    });

    function openCardModal(sectionKey, cardId) {
        formFields.id.value = '';
        formFields.section_key.value = sectionKey || '';
        formFields.card_title.value = '';
        formFields.card_subtitle.value = '';
        formFields.content.value = '';
        formFields.note.value = '';
        formFields.file_upload.value = ''; 
        formFields.existingImagesContainer.innerHTML = '';

        if (cardId) {
            const card = allCards.find(c => c.id == cardId);
            if (card) {
                formFields.id.value = card.id;
                formFields.section_key.value = card.section_key;
                formFields.card_title.value = card.card_title;
                formFields.card_subtitle.value = card.card_subtitle || '';
                formFields.content.value = card.content || '';
                formFields.note.value = card.note || '';
                (card.image_urls || []).forEach(appendExistingImage);
            }
        }
        cardModal.show();
    }

    async function deleteCard(cardId) {
        if (!confirm('確定刪除？')) return;
        await fetch(`${API_URL_CARDS}/delete/${cardId}`, { method: 'DELETE' });
        loadAllData();
    }

    function toggleDragMode(event) {
        event.preventDefault();
        const containers = document.querySelectorAll('.card-container');
        if (!containers.length) return;
        const isEnabled = !containers[0].classList.contains('drag-mode');
        containers.forEach(c => {
            const sortable = Sortable.get(c);
            if (sortable) sortable.option("disabled", !isEnabled);
            c.classList.toggle('drag-mode', isEnabled);
        });
        toggleDragButton.classList.toggle('btn-secondary', !isEnabled);
        toggleDragButton.classList.toggle('btn-warning', isEnabled);
        toggleDragButton.innerHTML = isEnabled ? '<i class="fas fa-mouse-pointer me-1"></i>' : '<i class="fas fa-hand-rock me-1"></i>';
    }

    function openImageModal(src, caption) {
        document.getElementById('imagePreviewImg').src = src;
        document.getElementById('imagePreviewCaption').textContent = caption || '';
        new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
    }

    window.openCardModal = openCardModal;
    window.deleteCard = deleteCard;
    window.toggleDragMode = toggleDragMode;
    window.openImageModal = openImageModal;

    document.addEventListener('DOMContentLoaded', loadAllData);
</script>
</body>
</html>