<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>XTS Retry List </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
  >
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
  />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

  <style>
    /* ... (CSS æ¨£å¼ä¿æŒä¸è®Šï¼Œç•¥) ... */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e5f0ff 0%, #f9fafb 40%, #f5f5f5 100%);
      color: #333;
    }

    .page-wrap {
      width: 96%;
      max-width: 1600px;
      margin: 20px auto 40px;
    }

    .tab-title {
      font-size: 2rem;
      font-weight: 700;
      color: #1e3a8a;
      margin-bottom: 5px;
    }

    .tab-subtitle {
      font-size: 1rem;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .suite-block {
      background: #fff;
      padding: 15px 15px 12px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      border: 1px solid #e5e7eb;
      overflow-x: auto;
    }

    /* ğŸŒŸ æ‹–æ›³æ¨¡å¼æ¨£å¼ ğŸŒŸ */
    .drag-mode .suite-block {
        cursor: grab !important;
        border: 1px dashed #3b82f6;
        transition: all 0.15s ease;
    }

    .drag-mode .suite-block:active {
        cursor: grabbing !important;
    }

    /* æ‹–æ›³æ™‚çš„é™°å½±æ•ˆæœ */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6;
        border: 1px dashed #1e3a8a;
    }


    .suite-block h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #1e3a8a;
    }

    .retry-section-tag {
        font-size: 0.8rem;
        color: #22c1c3;
        background: #e0f2f1;
        padding: 2px 10px;
        border-radius: 999px;
        font-weight: 600;
        display: inline-block;
        margin-left: 10px;
    }

    /* ==================================================== */
    /* è¡¨æ ¼æ¨£å¼ - æœ€çµ‚ä¿®æ­£ç‰ˆï¼šæ¢å¾©é«˜åº¦ï¼Œä¸¦ç¢ºä¿åŠŸèƒ½é‹ä½œ */
    /* ==================================================== */
    table {
      width: 100%;
      min-width: 1000px;
      table-layout: fixed;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      vertical-align: top;
      color: #333;
      word-wrap: break-word;
    }

    th {
      background: #f3f4f6;
      text-align: center;
      color: #1f2937;
      font-weight: 600;
    }

    /* ğŸŒŸ å®¢è£½åŒ–æ¬„å¯¬è¨­å®š (ç¶­æŒä¸Šä¸€æ¬¡çš„æ¯”ä¾‹) ğŸŒŸ */
    .retry-table[data-type$="IC"] th:nth-child(1), .retry-table[data-type$="IC"] td:nth-child(1),
    .retry-table[data-type="GTS"] th:nth-child(1), .retry-table[data-type="GTS"] td:nth-child(1),
    .retry-table[data-type="CTS"] th:nth-child(1), .retry-table[data-type="CTS"] td:nth-child(1),
    .retry-table[data-type$="TOT"] th:nth-child(1), .retry-table[data-type$="TOT"] td:nth-child(1) { width: 38%; }

    .retry-table[data-type="SPECIAL"] th:nth-child(1), .retry-table[data-type="SPECIAL"] td:nth-child(1) { width: 45%; }
    .retry-table[data-type="SPECIAL"] th:nth-child(2), .retry-table[data-type="SPECIAL"] td:nth-child(2) { width: 47%; }

    .retry-table:not([data-type="SPECIAL"]) th:nth-child(2), .retry-table:not([data-type="SPECIAL"]) td:nth-child(2) { width: 25%; text-align: left; }
    .retry-table:not([data-type="SPECIAL"]) th:nth-child(3), .retry-table:not([data-type="SPECIAL"]) td:nth-child(3) { width: 29%; text-align: left; }

    th:nth-child(4), td:nth-child(4) { width: 8%; text-align: center; }

    /* æ“ä½œæŒ‰éˆ•å®¹å™¨ - ä¿æŒå±…ä¸­ */
    .action-buttons-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        height: 100%;
        padding: 0;
    }

    /* æ“ä½œæŒ‰éˆ•æ¨£å¼ */
    .action-btn {
      padding: 5px 8px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      line-height: 1;
      text-decoration: none;
      transition: filter 0.1s;
    }

    .action-btn.edit-btn {
      background-color: #3b82f6;
      color: white;
      border: 1px solid #2563eb;
    }
    .action-btn.delete-btn {
      background-color: #ef4444;
      color: white;
      border: 1px solid #dc2626;
    }

    .action-btn:hover { filter: brightness(0.9); }

    /* åˆ—è¡¨å€å¡Šæ¨™é¡Œ */
    .retry-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }

    /* å›åˆ°é¦–é é€£çµ */
    .back-link {
        padding: 20px 0 0;
        margin-top: 20px;
        font-size: 16px;
        border-top: 1px solid #e5e7eb;
        max-width: 1600px;
        margin-left: auto;
        margin-right: auto;
    }
    .back-link a {
        color: #3b82f6;
        text-decoration: none;
    }

    /* ğŸŒŸ éš±è— Modal æ¬„ä½ ğŸŒŸ */
    .modal-hidden-field {
        display: none !important;
    }

  </style>
</head>

<body>
<div class="page-wrap">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="header-text">
        <div class="tab-title"> XTS Retry List  </div>
        <div class="tab-subtitle">
          æœ‰é‡åˆ°ç›¸åŒ fail å¯ä»¥å…ˆå°ä¸€ä¸‹ï¼Œæœ‰é‡åˆ°æ–°çš„æ‰‹æ³•ä¹Ÿå¸Œæœ›èƒ½æ–°å¢ã€‚
            <p class="note-text" style="font-size: 14px; color: #666; margin-top: 4px;">
                é»æ“Šåˆ—è¡¨ä¸­çš„ <span class="badge bg-primary"><i class="fas fa-pencil-alt"></i></span> æˆ– <span class="badge bg-danger"><i class="fas fa-times"></i></span> æŒ‰éˆ•ä¾†ä¿®æ”¹/åˆªé™¤æ—¢æœ‰çš„ç´€éŒ„ã€‚
            </p>
        </div>
      </div>

      <div class="btn-group">
          <button class="btn btn-secondary me-2" id="toggleDragBtn" onclick="toggleDragMode(event)">
                  <i class="fas fa-hand-rock me-1"></i>
          </button>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newSuiteModal">
              <i class="fas fa-plus me-1"></i> æ–°å¢å€å¡Š
          </button>
      </div>

    </div>

    <div id="suites-container">
        <p class="text-center text-muted" id="loading-suites">æ­£åœ¨è¼‰å…¥å€å¡Š...</p>
    </div>


</div>

<div class="modal fade" id="retryModal" tabindex="-1" aria-labelledby="retryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="retryModalLabel">Retry æŠ€å·§æ–¹æ³•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="retryForm">
            <input type="hidden" id="retry_id_pk" value="">

            <div class="mb-3 modal-hidden-field" id="retry-type-group">
                <label for="retry_type" class="form-label">Retry é¡å‹</label>
                <input type="text" class="form-control" id="retry_type" readonly required>
            </div>

            <div class="mb-3" id="module-case-group">
                <label for="module_case" class="form-label">æ¨¡çµ„ / æ¸¬é … (å¿…å¡«)</label>
                <textarea class="form-control" id="module_case" rows="2" required></textarea>
            </div>

            <div class="mb-3" id="condition-group">
                <label for="condition" class="form-label">é—œéµæ¢ä»¶ / ç’°å¢ƒ (å¿…å¡«)</label>
                <textarea class="form-control" id="condition" rows="2" required></textarea>
            </div>

            <div class="mb-3" id="trick-group">
                <label for="trick" class="form-label">å‚™è¨» / Retry æ–¹æ³• (å¿…å¡«)</label>
                <textarea class="form-control" id="trick" rows="3" required></textarea>
            </div>

        </form>
    </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveRetryBtn">å„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="newSuiteModal" tabindex="-1" aria-labelledby="newSuiteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSuiteModalLabel">æ–°å¢æ¸¬è©¦å¥—ä»¶å€å¡Š</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newSuiteForm">
                    <div class="mb-3">
                        <label for="new_suite_title" class="form-label">å€å¡Šæ¨™é¡Œ (å¿…å¡«)</label>
                        <input type="text" class="form-control" id="new_suite_title" required>
                        <div class="form-text text-muted">ä¾‹å¦‚ï¼šSTS æ¸¬é …</div>
                    </div>

                    <div class="mb-3">
                        <label for="new_suite_tag" class="form-label">æ¨™ç±¤ / ç°¡çŸ­èªªæ˜</label>
                        <input type="text" class="form-control" id="new_suite_tag">
                        <div class="form-text text-muted">æ­¤æ¬„ä½è‹¥æœ‰å¡«å¯«ï¼Œå°‡ä½œç‚ºè©²å€å¡Šçš„è­˜åˆ¥ Keyï¼Œä¸å¯é‡è¤‡ã€‚</div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveNewSuiteBtn">æ–°å¢å€å¡Š</button>
            </div>
        </div>
    </div>
</div>


<div class="back-link">
    <a href="/">â† å›åˆ°é¦–é </a>
</div>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>

<script>
    // æœ€çµ‚ä¿®æ­£ç‰ˆæœ¬ï¼šä¿®å¾© SPECIAL ç·¨è¼¯éŒ¯èª¤ï¼Œä¸¦ç¢ºä¿æ‰€æœ‰æ¬„ä½å¿…å¡«
    const API_URL_RETRY = '/api/retry';
    const API_URL_SUITES = '/api/suites';

    let localSuitesList = [];
    let localRetryTips = [];

    const retryModalElement = document.getElementById('retryModal');
    const newSuiteModalElement = document.getElementById('newSuiteModal');

    const retryModal = new bootstrap.Modal(retryModalElement);
    const newSuiteModal = new bootstrap.Modal(newSuiteModalElement);

    const saveRetryButton = document.getElementById('saveRetryBtn');
    const saveNewSuiteButton = document.getElementById('saveNewSuiteBtn');
    const toggleDragButton = document.getElementById('toggleDragBtn');

    // æ‹–æ›³å¯¦ä¾‹è®Šæ•¸
    let sortableInstance = null;

    // æ¸¬é …è¡¨å–®æ¬„ä½
    const retryFormFields = {
        id: document.getElementById('retry_id_pk'),
        type: document.getElementById('retry_type'),
        module_case: document.getElementById('module_case'),
        condition: document.getElementById('condition'),
        trick: document.getElementById('trick')
    };

    const inputGroups = {
        type: document.getElementById('retry-type-group'),
        module_case: document.getElementById('module-case-group'),
        condition: document.getElementById('condition-group'),
        trick: document.getElementById('trick-group')
    };


    // æ–°å¢å€å¡Šè¡¨å–®æ¬„ä½
    const newSuiteFormFields = {
        title: document.getElementById('new_suite_title'),
        tag: document.getElementById('new_suite_tag')
    };

    // ==========================================================
    // è¼”åŠ©å‡½æ•¸ï¼šå°‡æ›è¡Œç¬¦(\n)è½‰æ›ç‚ºHTMLæ›è¡Œæ¨™ç±¤(<br>)
    // ==========================================================
    function nl2br(str) {
        if (!str) return '';
        return str.replace(/(?:\r\n|\r|\n)/g, '<br>');
    }

    // ==========================================================
    // 1. è¼‰å…¥å‡½å¼ç¸½å…¥å£
    // ==========================================================
    async function loadAllData() {
        const loadingMessage = document.getElementById('loading-suites');
        if (loadingMessage) loadingMessage.textContent = 'æ­£åœ¨è¼‰å…¥å€å¡Šå’Œæ¸¬é …...';

        try {
            // 1. å–å¾—å€å¡Šåˆ—è¡¨
            const suiteResponse = await fetch(`${API_URL_SUITES}/list`);
            if (!suiteResponse.ok) throw new Error('Failed to load suites list');
            localSuitesList = await suiteResponse.json();

            // 2. å–å¾—æ¸¬é …åˆ—è¡¨
            const tipsResponse = await fetch(`${API_URL_RETRY}/list`);
            if (!tipsResponse.ok) throw new Error('Failed to load retry tips');
            localRetryTips = await tipsResponse.json();

            // 3. æ¸²æŸ“é é¢
            renderPageLayout();

            // ç¢ºä¿æ¯æ¬¡æ¸²æŸ“å®Œæˆå¾Œï¼ŒSortable.js å¯¦ä¾‹è¢«å‰µå»ºä½†è™•æ–¼ç¦ç”¨ç‹€æ…‹
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
            initializeSorting();

        } catch (error) {
            console.error('Failed to load data:', error);
            const container = document.getElementById('suites-container');
            container.innerHTML = `<p class="text-center text-danger">æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ APIï¼š${error.message}</p>`;
        }
    }

    // ==========================================================
    // 2. æ¸²æŸ“é é¢çµæ§‹ (å‹•æ…‹å€å¡Š)
    // ==========================================================
    function renderPageLayout() {
        const container = document.getElementById('suites-container');
        container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨

        const dataByGroup = localRetryTips.reduce((acc, item) => {
            const key = item.type ? item.type.toUpperCase() : 'UNKNOWN';
            acc[key] = acc[key] || [];
            acc[key].push(item);
            return acc;
        }, {});

        const loadingMessage = document.getElementById('loading-suites');
        if (loadingMessage) loadingMessage.remove();

        if (localSuitesList.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">ç›®å‰æ²’æœ‰ä»»ä½•æ¸¬è©¦å€å¡Šï¼Œè«‹é»æ“Šã€Œæ–°å¢å€å¡Šã€å»ºç«‹ã€‚</p>';
            return;
        }

        localSuitesList.forEach(suite => {
            const suiteKey = suite.suite_key.toUpperCase();
            const typeData = dataByGroup[suiteKey] || [];

            const isSpecial = (suiteKey === 'SPECIAL');

            let headerCols;
            if (isSpecial) {
                // å®¢è£½åŒ– SPECIAL è¡¨é ­ (ä¸‰æ¬„)
                headerCols = `
                    <th>æ¨¡çµ„/æ¸¬é … / æ¢ä»¶ / ç’°å¢ƒ</th>
                    <th>å‚™è¨» / Retry æ–¹æ³•</th>
                    <th>Edit / Delete</th>
                `;
            } else {
                // æ¨™æº–å››æ¬„è¡¨é ­
                headerCols = `
                    <th>æ¨¡çµ„ / æ¸¬é …</th>
                    <th>é—œéµæ¢ä»¶ / ç’°å¢ƒ</th>
                    <th>å‚™è¨» / Retry æŠ€å·§</th>
                    <th>Edit / Delete</th>
                `;
            }

            // æ¸²æŸ“å€å¡Š HTML
            const suiteBlockHtml = `
                <div class="suite-block" id="${suiteKey.toLowerCase()}-section" data-suite-key="${suiteKey}">
                    <div class="retry-list-header">
                        <div class="d-flex align-items-center">
                            <h2>${suite.suite_title}</h2>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-primary me-2 add-tip-btn" data-bs-toggle="modal" data-bs-target="#retryModal" data-id="new" data-type-preset="${suiteKey}">
                                <i class="fas fa-plus"></i> æ–°å¢æ¸¬é …
                            </button>
                            <button class="btn btn-sm btn-danger delete-suite-btn" data-type="${suiteKey}" onclick="deleteSuite('${suiteKey}', event)" title="åˆªé™¤æ•´å€‹ ${suite.suite_title} å€å¡Š">
                                <i class="fas fa-trash-alt"></i> åˆªé™¤å€å¡Š
                            </button>
                        </div>
                    </div>

                    <table class="retry-table" data-type="${suiteKey}">
                        <thead>
                            <tr>
                                ${headerCols}
                            </tr>
                        </thead>
                        <tbody>
                            ${renderTableBody(suiteKey, typeData)}
                        </tbody>
                    </table>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', suiteBlockHtml);
        });
    }

    // 3. æ¸²æŸ“è¡¨æ ¼å…§å®¹
    function renderTableBody(suiteKey, typeData) {
        const isSpecial = (suiteKey === 'SPECIAL');
        const colspan = isSpecial ? 3 : 4;

        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œæ ¹æ“š header æ¬„æ•¸å›å‚³æ­£ç¢ºçš„ colspan
        if (!typeData || typeData.length === 0) {
            return `<tr><td colspan="${colspan}" class="text-center">ç›®å‰æ²’æœ‰ ${suiteKey} çš„ Retry é …ç›®ã€‚</td></tr>`;
        }

        // ç‚ºé¿å…æ¬„ä½éŒ¯èª¤ï¼Œæ¯ä¸€åˆ—æœƒä¾ isSpecial ç”¢ç”Ÿæ­£ç¢ºæ•¸é‡çš„ <td>
        if (isSpecial) {
            // ä¸‰æ¬„æ¨¡å¼ï¼šæ¨¡çµ„/æ¸¬é …+æ¢ä»¶ã€å‚™è¨»ã€æ“ä½œ
            return typeData.map(item => `
                <tr data-id="${item.id}" data-type="${item.type}">
                    <td>${nl2br(item.module_case) + (item.module_case && item.condition ? '<hr style="border:none;border-top:1px dashed #eee;margin:6px 0;">' : '') + nl2br(item.condition)}</td>
                    <td>${nl2br(item.trick) || '-'}</td>
                    <td class="text-center">
                        <div class="action-buttons-wrapper">
                            <a href="#" class="action-btn edit-btn" onclick="openModalForEdit(${item.id}, event)" title="ç·¨è¼¯">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="#" class="action-btn delete-btn" onclick="deleteRetryTip(${item.id}, event)" title="åˆªé™¤">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `).join('');
        } else {
            // å››æ¬„æ¨¡å¼ï¼šæ¨¡çµ„ã€æ¢ä»¶ã€å‚™è¨»ã€æ“ä½œ
            return typeData.map(item => `
                <tr data-id="${item.id}" data-type="${item.type}">
                    <td>${nl2br(item.module_case)}</td>
                    <td>${nl2br(item.condition)}</td>
                    <td>${nl2br(item.trick) || '-'}</td>
                    <td class="text-center">
                        <div class="action-buttons-wrapper">
                            <a href="#" class="action-btn edit-btn" onclick="openModalForEdit(${item.id}, event)" title="ç·¨è¼¯">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="#" class="action-btn delete-btn" onclick="deleteRetryTip(${item.id}, event)" title="åˆªé™¤">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // ==========================================================
    // 6. æ‹–æ›³æ’åºé‚è¼¯ (Sortable.js)
    // ==========================================================
    function initializeSorting() {
        const container = document.getElementById('suites-container');

        if (typeof Sortable === 'undefined') {
            console.error("Sortable.js not loaded.");
            return;
        }

        sortableInstance = Sortable.create(container, {
            animation: 150,
            handle: '.suite-block',
            ghostClass: 'sortable-ghost',
            disabled: true, // ğŸŒŸ é è¨­ç‚ºç¦ç”¨ ğŸŒŸ
            onEnd: async function (evt) {
                // æ‹–æ›³çµæŸæ™‚è§¸ç™¼
                const items = evt.from.children;
                const newOrderKeys = [];

                for (let i = 0; i < items.length; i++) {
                    const key = items[i].getAttribute('data-suite-key');
                    if (key) {
                        newOrderKeys.push(key);
                    }
                }

                if (newOrderKeys.length === 0) return;

                // å‘¼å«å¾Œç«¯ API æ›´æ–°æ’åº
                try {
                    const response = await fetch(`${API_URL_SUITES}/reorder`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(newOrderKeys)
                    });

                    if (response.ok) {
                        loadAllData();
                    } else {
                        const errorData = await response.json();
                        alert(`æ’åºå¤±æ•—: ${errorData.message || 'ä¼ºæœå™¨éŒ¯èª¤'}`);
                        loadAllData();
                    }
                } catch (error) {
                    alert('é€£ç·šå¤±æ•—ï¼Œç„¡æ³•ä¿å­˜æ–°é †åºã€‚');
                    console.error('Reorder failed:', error);
                    loadAllData();
                }
            }
        });
    }

    // ğŸŒŸ æ‹–æ›³æ¨¡å¼é–‹é—œå‡½æ•¸ ğŸŒŸ
    function toggleDragMode(event) {
        event.preventDefault();

        const container = document.getElementById('suites-container');

        if (!sortableInstance) {
            initializeSorting();
        }

        if (sortableInstance.options.disabled) {
            // å•Ÿç”¨æ‹–æ›³æ¨¡å¼
            sortableInstance.option("disabled", false);
            container.classList.add('drag-mode');
            toggleDragButton.innerHTML = '<i class="fas fa-mouse-pointer me-1"></i> ç¦ç”¨æ’åº';
            toggleDragButton.classList.remove('btn-secondary');
            toggleDragButton.classList.add('btn-warning');

        } else {
            // ç¦ç”¨æ‹–æ›³æ¨¡å¼
            sortableInstance.option("disabled", true);
            container.classList.remove('drag-mode');
            toggleDragButton.innerHTML = '<i class="fas fa-hand-rock me-1"></i> å•Ÿç”¨æ’åº';
            toggleDragButton.classList.remove('btn-warning');
            toggleDragButton.classList.add('btn-secondary');
        }
    }


    // ==========================================================
    // 4. æ¸¬é … CRUD é‚è¼¯ (æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤è¡¨æ ¼å…§å–®è¡Œ)
    // ==========================================================

    // å„²å­˜æ¸¬é … (æ–°å¢/ä¿®æ”¹)
    saveRetryButton.addEventListener('click', async () => {
        const currentType = retryFormFields.type.value.toUpperCase();
        const isSpecial = (currentType === 'SPECIAL');

        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!retryFormFields.condition.value.trim() || !retryFormFields.trick.value.trim()) {
            alert('ã€Œæ¢ä»¶ / ç’°å¢ƒã€å’Œã€Œå‚™è¨»ã€ç‚ºå¿…å¡«æ¬„ä½ã€‚');
            return;
        }

        if (!isSpecial && !retryFormFields.module_case.value.trim()) {
            alert('ã€Œæ¨¡çµ„ / æ¸¬é …ã€ç‚ºå¿…å¡«æ¬„ä½ã€‚');
            return;
        }

        const id = retryFormFields.id.value;
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL_RETRY}/update/${id}` : `${API_URL_RETRY}/add`;

        const data = {
            type: currentType,
            // ğŸŒŸ é—œéµä¿®æ­£: SPECIAL æ¨¡å¼ä¸‹ï¼Œmodule_case å¿…é ˆå‚³é€ç©ºå­—ä¸²ï¼Œé˜²æ­¢æ•¸æ“šåº«é©—è­‰å¤±æ•— ğŸŒŸ
            module_case: isSpecial ? "" : retryFormFields.module_case.value,
            condition: retryFormFields.condition.value,
            trick: retryFormFields.trick.value
        };

        try {
            const response = await fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.status === 'ok') {
                alert(`Retry ç´€éŒ„å·²${id ? 'æ›´æ–°' : 'æ–°å¢'}æˆåŠŸï¼`);
                retryModal.hide();
                loadAllData(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š (å³æ™‚åé¥‹)
            } else {
                alert(`æ“ä½œå¤±æ•—: ${result.message || 'ä¼ºæœå™¨éŒ¯èª¤'}`);
            }
        } catch (error) {
            alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚');
            console.error('Save failed:', error);
        }
    });

    // åˆªé™¤æ¸¬é … (ä¿æŒä¸è®Š)
    async function deleteRetryTip(id, event) {
        event.preventDefault();
        event.stopPropagation();
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­† ID ç‚º ${id} çš„ Retry é …ç›®å—ï¼Ÿ`)) {
            return;
        }

        try {
            const response = await fetch(`${API_URL_RETRY}/delete/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok && result.status === 'ok') {
                alert('Retry ç´€éŒ„å·²æˆåŠŸåˆªé™¤ï¼');
                loadAllData(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š (å³æ™‚åé¥‹)
            } else {
                alert(`åˆªé™¤å¤±æ•—: ${result.message || 'ä¼ºæœå™¨éŒ¯èª¤'}`);
            }
        } catch (error) {
            alert('é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚');
            console.error('Delete failed:', error);
        }
    }

    // ğŸŒŸ ç·¨è¼¯æ™‚å¡«å……è¡¨å–® (æ ¹æ“š SPECIAL é¡å‹èª¿æ•´ Modal é¡¯ç¤º) ğŸŒŸ
    function openModalForEdit(id, event) {
        event.preventDefault();
        event.stopPropagation();

        const item = localRetryTips.find(d => d.id === id);
        if (!item) {
            alert('æ‰¾ä¸åˆ°è©²ç´€éŒ„ï¼');
            return;
        }

        const isSpecial = (item.type.toUpperCase() === 'SPECIAL');

        document.getElementById('retryModalLabel').textContent = `ç·¨è¼¯ Retry æŠ€å·§ (ID: ${id})`;

        // ğŸŒŸ 1. é‡ç½®ä¸¦è¨­å®šé¡¯ç¤º/éš±è— ğŸŒŸ
        if (isSpecial) {
            inputGroups.module_case.classList.add('modal-hidden-field'); // éš±è— Module/æ¸¬é …
            document.querySelector('#condition-group label').textContent = 'æ¢ä»¶ / ç’°å¢ƒ (å¿…å¡«)';
            document.querySelector('#trick-group label').textContent = 'å‚™è¨» (å¿…å¡«)';
            retryFormFields.condition.required = true;
            retryFormFields.trick.required = true;
        } else {
            inputGroups.module_case.classList.remove('modal-hidden-field'); // é¡¯ç¤º Module/æ¸¬é …
            document.querySelector('#condition-group label').textContent = 'é—œéµæ¢ä»¶ / ç’°å¢ƒ (å¿…å¡«)';
            document.querySelector('#trick-group label').textContent = 'å‚™è¨» / Retry æ–¹æ³•';
            retryFormFields.condition.required = true;
            retryFormFields.trick.required = false; // æ¨™æº–æ¨¡å¼çš„ trick éå¿…å¡«
        }
        inputGroups.type.classList.add('modal-hidden-field'); // é¡å‹æ°¸é éš±è—

        // ğŸŒŸ 2. å¡«å……æ•¸æ“š ğŸŒŸ
        retryFormFields.id.value = item.id;
        retryFormFields.type.value = item.type;
        retryFormFields.module_case.value = item.module_case || ''; // å³ä½¿éš±è—ä¹Ÿè¦å¡«å……æ•¸æ“šåº«å€¼
        retryFormFields.condition.value = item.condition;
        retryFormFields.trick.value = item.trick;

        retryModal.show();
    }


    // ==========================================================
    // 5. å€å¡Š CRUD é‚è¼¯ (æ–°å¢ã€åˆªé™¤å¤§å€å¡Š)
    // ==========================================================

    // å„²å­˜æ–°å€å¡Š (ä¿æŒä¸è®Š)
    saveNewSuiteButton.addEventListener('click', async () => {
        // åªéœ€è¦æª¢æŸ¥ title æ˜¯å¦å¿…å¡«
        if (!newSuiteFormFields.title.value.trim()) {
             alert('è«‹å¡«å¯«ã€Œå€å¡Šæ¨™é¡Œã€æ¬„ä½ã€‚');
             return;
        }

        const data = {
            suite_title: newSuiteFormFields.title.value.trim(),
            suite_tag: newSuiteFormFields.tag.value.trim()
        };

        try {
            const response = await fetch(`${API_URL_SUITES}/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.status === 'ok') {
                alert(`æ–°çš„å€å¡Š "${data.suite_title}" å·²æˆåŠŸæ–°å¢ï¼Key: ${result.suite_key}`);
                newSuiteModal.hide();
                loadAllData(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š (å³æ™‚åé¥‹)
            } else {
                // è™•ç† Key é‡è¤‡ç­‰éŒ¯èª¤ (409 Conflict)
                alert(`æ–°å¢å€å¡Šå¤±æ•—: ${result.message || 'ä¼ºæœå™¨éŒ¯èª¤'}`);
            }
        } catch (error) {
            alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚');
            console.error('Add Suite failed:', error);
        }
    });

    // åˆªé™¤å€å¡Š (ä¿æŒä¸è®Š)
    async function deleteSuite(suiteKey, event) {
        event.preventDefault();
        event.stopPropagation();

        // æª¢æŸ¥è©²å€å¡Šä¸‹æ˜¯å¦æœ‰æ¸¬é …æ•¸æ“š
        const itemsCount = localRetryTips.filter(item => item.type === suiteKey).length;

        let confirmMessage;
        if (itemsCount > 0) {
             confirmMessage = `è­¦å‘Šï¼š"${suiteKey}" å€å¡Šä¸‹é‚„æœ‰ ${itemsCount} æ¢æ¸¬é …ç´€éŒ„ã€‚ç¢ºå®šè¦åˆªé™¤æ•´å€‹å€å¡ŠåŠå…¶æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ`;
        } else {
            confirmMessage = `ç¢ºå®šè¦åˆªé™¤ "${suiteKey}" å€å¡Šå—ï¼Ÿ`;
        }

        if (!confirm(confirmMessage)) {
            return;
        }

        try {
            const response = await fetch(`${API_URL_SUITES}/delete/${suiteKey}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (response.ok && result.status === 'ok') {
                alert(`å€å¡Š "${suiteKey}" å·²æˆåŠŸåˆªé™¤ï¼`);
                loadAllData(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š (å³æ™‚åé¥‹)
            } else {
                alert(`åˆªé™¤å¤±æ•—: ${result.message || 'ä¼ºæœå™¨éŒ¯èª¤'}`);
            }
        } catch (error) {
            alert('é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œã€‚');
            console.error('Delete Suite failed:', error);
        }
    }

    // Modal é¡¯ç¤º/éš±è—ç­‰é‚è¼¯
    retryModalElement.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;

        // å¦‚æœæ˜¯æ–°å¢ (é»æ“Šã€Œæ–°å¢æ¸¬é …ã€æŒ‰éˆ•)
        if (button && button.dataset.id === 'new') {
            document.getElementById('retryModalLabel').textContent = 'æ–°å¢ Retry é …ç›®'
            // æ¸…ç©ºè¡¨å–®
            retryFormFields.id.value = '';
            retryFormFields.module_case.value = '';
            retryFormFields.condition.value = '';
            retryFormFields.trick.value = '';

            const presetType = button.dataset.typePreset;
            retryFormFields.type.value = presetType || 'UNKNOWN';

            // ğŸŒŸ æ–°å¢æ™‚ï¼Œæ ¹æ“šé¡å‹é è¨­ Modal ç‹€æ…‹ ğŸŒŸ
            const isSpecial = (presetType === 'SPECIAL');
            if (isSpecial) {
                inputGroups.module_case.classList.add('modal-hidden-field'); // éš±è— Module/æ¸¬é …
                document.querySelector('#condition-group label').textContent = 'æ¢ä»¶ / ç’°å¢ƒ (å¿…å¡«)';
                document.querySelector('#trick-group label').textContent = 'å‚™è¨» (å¿…å¡«)';
            } else {
                inputGroups.module_case.classList.remove('modal-hidden-field'); // é¡¯ç¤º Module/æ¸¬é …
                document.querySelector('#condition-group label').textContent = 'é—œéµæ¢ä»¶ / ç’°å¢ƒ (å¿…å¡«)';
                document.querySelector('#trick-group label').textContent = 'å‚™è¨» / Retry æ–¹æ³•';
            }
            inputGroups.type.classList.add('modal-hidden-field'); // é¡å‹æ°¸é éš±è—
        }
        // ç·¨è¼¯é‚è¼¯å·²åœ¨ openModalForEdit å‡½æ•¸ä¸­è™•ç†
    });

    // æ¸…é™¤æ–°å¢å€å¡Š Modal ç‹€æ…‹
    newSuiteModalElement.addEventListener('hidden.bs.modal', () => {
        document.getElementById('newSuiteForm').reset();
    });

    // ==========================================================
    // 6. åˆå§‹è¼‰å…¥
    // ==========================================================
    document.addEventListener('DOMContentLoaded', loadAllData);

    // æš´éœ²å…¨åŸŸå‡½æ•¸çµ¦ HTML å…§è¯äº‹ä»¶ä½¿ç”¨
    window.openModalForEdit = openModalForEdit;
    window.deleteRetryTip = deleteRetryTip;
    window.deleteSuite = deleteSuite;
    window.toggleDragMode = toggleDragMode;

</script>
</body>
</html>